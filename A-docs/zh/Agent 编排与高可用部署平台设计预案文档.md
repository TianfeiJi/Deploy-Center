# Agent 编排与高可用部署平台设计预案文档

## 背景

当前部署平台为中心化设计，Center 可通过 Web 管理界面与 API 下发部署任务，Agent 负责项目容器化部署。随着节点数量增长和服务高可用性的需求增加，有必要升级平台架构，实现多 Agent 协同、任务编排、容器健康感知和自动迁移能力。

---

## 功能目标概述

### 🎯 核心目标

- 实现 Center 对 Agent 节点的集中调度与资源感知
- 支持多节点部署、健康检查与自动故障迁移
- 提供容器级服务的高可用能力：部署 -> 监控 -> 自愈 -> 复原

---

## 系统组件

### 1. DeployCenter（部署中心）

- 负责维护所有 Agent 的注册信息
- 提供任务派发、调度策略、服务监控逻辑
- 提供 Web UI / API 接口供用户操作

### 2. Agent 节点

- 实际部署、运行、管理容器服务的工作节点
- 定时上报自身状态（如资源使用率、容器运行状态）
- 接收 Center 的任务指令：部署、更新、删除、滚动重启等

### 3. Heartbeat + 资源上报机制

- 每个 Agent 每 5 秒上报一次心跳（含 CPU、内存、端口、磁盘等信息）
- Center 维护 Agent 在线状态表，异常自动标记为“不可用”

---

## 核心功能设计

### ✅ 多 Agent 节点注册与调度

- Agent 启动后通过 `/api/agent/register` 向 Center 注册
- Center 记录：Agent 名称、IP、标签、权重、资源、当前任务列表
- 部署任务分发时，支持调度策略选择：

| 策略 | 描述 |
|------|------|
| 最空闲策略 | 优先分配 CPU + Mem 剩余最多的 Agent |
| 标签匹配策略 | 按标签匹配，如 “北京”、“GPU” |
| 项目亲和策略 | 若已有此项目历史部署，优先使用原 Agent |

---

### 🛠️ Agent 资源感知与服务运行状态上报

```json
{
  "agent_id": "agent-abc",
  "cpu_usage": 42.1,
  "mem_free_mb": 2378,
  "disk_free_gb": 120,
  "containers": [
    {
      "project_code": "auth-service",
      "status": "running",
      "uptime": "3h25m"
    },
    ...
  ]
}
```

### 🔁 高可用自愈机制（容器级别）

- Agent 上的服务通过定时健康检查脚本或容器状态检测实现自监控
- 若 Agent 整体下线，Center 检测其离线后：
  - 标记其上运行的项目为“已中断”
  - 启动自动部署流程，在其他可用 Agent 上重启等价服务（自动换端口）

---

## 示例：服务高可用部署流程

1. A 项目原本运行在 agent-001 上
2. agent-001 心跳丢失超过 15 秒，被 Center 标记为离线
3. Center 执行以下流程：
    - 从数据库读取 A 项目的部署配置
    - 查找可用 Agent：agent-002
    - 重新部署：镜像拉取 -> 容器启动
    - 更新运行状态记录

---

## 后续扩展

- 镜像仓库支持（本地 + 私有 Harbor）
- 滚动部署 / 灰度发布策略
- 服务依赖链部署（编排 DSL）
- Prometheus + Grafana 集成：资源 & 部署可视化监控
- 网关动态注册支持（容器服务上线即注册）

---

## 技术选型建议

| 模块         | 技术建议                                |
|--------------|-----------------------------------------|
| 通信协议     | HTTP REST + WebSocket（实时上报）      |
| 任务队列     | 内部先用内存队列，后期可换 Redis/RabbitMQ |
| 配置管理     | JSON + SQLite，后期支持 Consul/Nacos   |
| 镜像仓库     | DockerHub、阿里云镜像仓库、本地 Harbor  |
| 容器编排     | 自研为主，未来可兼容 k8s CRD            |

---

## 结语

本设计为 Agent 编排与服务高可用的初步设想，适用于中轻量级部署平台。目标是构建一个无需上手 Kubernetes、却能实现灵活多节点部署和恢复的运维部署解决方案。